# rpi
RPi all-in-one box
- Starting RPi from scratch for RADIUS, Pi-HOLE, UNIFI CONTROLLER, LAMP… YDNS edition.  This list is compiled from my experience and various other guides in the public domain.  Message me if you don&#39;t feel your guide has been properly credited here.
- credits:
-
- [https://elkano.org/blog/debian-8-jessie-signatures-verified-public](https://elkano.org/blog/debian-8-jessie-signatures-verified-public%20key/)
- [key/](https://elkano.org/blog/debian-8-jessie-signatures-verified-public%20key/) [https://stribika.github.io/2015/01/04/secure-secure-shell.html](https://stribika.github.io/2015/01/04/secure-secure-shell.html)
- [http://www.lowefamily.com.au/2016/06/02/installing-ubiquiti-unifi-controller-5-on-raspberry-pi/](http://www.lowefamily.com.au/2016/06/02/installing-ubiquiti-unifi-controller-5-on-raspberry-pi/)
- [http://www.jeffgeerling.com/blog/2016/how-overclock-microsd-card-reader-on-raspberry-pi-3](http://www.jeffgeerling.com/blog/2016/how-overclock-microsd-card-reader-on-raspberry-pi-3)
- [http://www.jeffgeerling.com/blogs/jeff-geerling/raspberry-pi-microsd-card](http://www.jeffgeerling.com/blogs/jeff-geerling/raspberry-pi-microsd-card)
- [https://jamielinux.com/docs/openssl-certificate-authority/introduction.html](https://jamielinux.com/docs/openssl-certificate-authority/introduction.html)
- [https://dcamero.azurewebsites.net/freeradius-daloradius.html](https://dcamero.azurewebsites.net/freeradius-daloradius.html)



- Using a 32GB Samsung EVO+ microsdhc card.
- Download the latest raspbian Jessie image here:
  - [https://www.raspberrypi.org/downloads/raspbian/](https://www.raspberrypi.org/downloads/raspbian/)
- Get win32diskimager here:
  - [https://sourceforge.net/projects/win32diskimager/](https://sourceforge.net/projects/win32diskimager/)
- Burn the image to the card
- Boot your pi
- Start optimizing (optional and you should probably have a heatsink if you want to do this)
  - Overclock the card reader
    - sudo bash -c &#39;printf &quot;dtoverlay=sdhost,overclock\_50=100\n&quot; &gt;&gt; /boot/config.txt&#39;
  - Overclock the pi
    - sudo nano /boot/config.txt
      - add these lines:
        - arm\_freq=1350
        - over\_voltage=6
  - reboot the pi
- Get updates:
  - Sudo apt-get update
  - Sudo apt-get upgrade
  - Wait, could take 10 mins or so
- make sure firmware updates are applied:
  - sudo apt-get install rpi-update &amp;&amp; echo Y | sudo rpi-update
- I prefer to do this all from another workstation over ssh so using putty, superPUTTY, secureCRT or whatever terminal emulator you want, ssh into your pi
  - ssh pi@&lt;pi IP address&gt;
- to me, the most important first steps include
  - setting a ridiculously long root password
    - sudo passwd root
      - add your root password
      - confirm your root password
  - setting the pi user password to something other than raspberry
    - sudo passwd
      - add your user password
      - confirm your user password
  - updating openssl to the version from Jessie-backports repository because its usually way more current than the one in debian-stable
- To do that we add the Jessie backports repo
  - Sudo nano /etc/apt/sources.list
    - deb http://ftp.debian.org/debian jessie-backports main
    - save and exit nano
    - login as root with the password you created above
  - add the debian keyrings you&#39;ll need (as root)
    - wget -O - https://ftp-master.debian.org/keys/archive-key-8.asc | apt-key add -
    - wget -O - https://ftp-master.debian.org/keys/archive-key-8-security.asc | apt-key add -
    - apt-key adv --keyserver keyserver.ubuntu.com --recv-keys 8B48AD6246925553
    - aptitude install debian-keyring debian-archive-keyring
    - apt-get update to update the package lists
    - type exit to go back to the normal pi user from root
  - sudo apt-get –t jessie-backports install openssl
    - now you&#39;ve got a much more current version of openssl than the one which ships with debian
      - its not a good idea to compile openssl from source and install it, it will break most everything that uses ssl so ive settled on just installing the backports package
- Now we&#39;ve got a pile of dependencies to tackle to get Webmin (very optional and I don&#39;t recommend using it), gdebi, UFW, freeRADIUS, and other software installed.
  - Sudo apt-get install gdebi
    - Gdebi makes it a lot easier to install packages because it builds dependencies and has them installed
  - Sudo apt-get install ufw
    - Install the firewall, and be prepared to have to access the pi locally instead of over the network as you configure rules and break your connectivity a couple times.
    - I prefer to block everything and allow from a select few local ports for various services as needed, but wait to see whats broken and then unblock afterwards.
    - Sudo ufw enable
      - Enables the firewall
    - Optional SSH allow/deny
      - This syntax can be used for every different port you need, we are just configuring port 22 right now for ssh
      - Allow from current computer only
        - Sudo ufw deny from &lt;your routers ip address&gt; to any port 22
        - Sudo ufw allow from &lt;your computers ip address&gt; to any port 22
        - Sudo ufw deny 22
          - This will give you ssh access from the computer youre currently using to remotely access the pi and no other location can connect via ssh
      - Allow from the local network your computer is on but not from the internet
        - Sudo ufw deny from &lt;your routers ip address&gt; to any port 22
        - sudo ufw allow from &lt;your local lan for example 192.168.1.0/24&gt; to any port 22
        - sudo ufw deny 22
  - Find the latest version of webmin and download it (optional, not recommended but can be useful for people who don&#39;t have a ton of familiarity with nix systems)
    - cd /tmp
    - wget [https://prdownloads.sourceforge.net/webadmin/webmin\_1.820\_all.deb](https://prdownloads.sourceforge.net/webadmin/webmin_1.820_all.deb)
    - sudo gdebi webmin\_1.820\_all.deb
  - restrict webmin access through the firewall:
    - Optional webmin allow/deny
      - This syntax can be used for every different port you need, we are just configuring port 10000 right now for webmin
      - Allow from current computer only
        - Sudo ufw deny from &lt;your routers ip address&gt; to any port 10000
        - Sudo ufw allow from &lt;your computers ip address&gt; to any port 10000
        - Sudo ufw deny 10000
          - This will give you ssh access from the computer youre currently using to remotely access the pi and no other location can connect via ssh
      - Allow from the local network your computer is on but not from the internet
        - Sudo ufw deny from &lt;your routers ip address&gt; to any port 10000
        - sudo ufw allow from &lt;your local lan for example 192.168.1.0/24&gt; to any port 10000
        - sudo ufw deny 10000
- We should probably stop here and talk about SSH hardening and restricted access.  There are a number of good guides out there for disallowing bad ciphers, certificate authentication, hardening, etc… Here&#39;s what I choose to use:
  - [https://stribika.github.io/2015/01/04/secure-secure-shell.html](https://stribika.github.io/2015/01/04/secure-secure-shell.html)
    - read through this so you understand what you&#39;re doing, or just copy the relevant configs
  - using google authenticator for time based one time passwords is a good idea as well.
  - for google authenticator to work properly you need to make sure your ntp configuration is such that the time for the pi is always close to real time or you&#39;ll get locked out.
- Google Authenticator configuration:
  - ADD THIS LATER
- okay, at this point we&#39;ve gotten the pi configured to the point the PI is safely overclocked (YMMV), SSH access is limited, you can manage it from webmin if you choose, and some dependencies taken care of towards the rest of the install.  What we can do now is start to build freeRADIUS + DaloRADIUS, install our ad-blocker (pi-hole) or continue with general RPi configuration.  I also use Ubiquiti Unifi access points so I install the controller onto a raspberry pi as well.
- Unifi Configuration:
  - echo &#39;deb http://www.ubnt.com/downloads/unifi/debian unifi5 ubiquiti&#39; | sudo tee -a /etc/apt/sources.list.d/ubnt.list &gt; /dev/null
  - sudo apt-key adv --keyserver keyserver.ubuntu.com --recv C0A52C50
  - sudo apt-get update
  - sudo apt-get install unifi -y
  - echo &#39;ENABLE\_MONGODB=no&#39; | sudo tee -a /etc/mongodb.conf &gt; /dev/null
    - this last part will make sure you don&#39;t have a running mongodb instance youre not using
  - go to https://&lt;your-pi-address&gt;:8443/manage/wizard
    - create a ubiquiti account or login to your existing one
    - adopt and configure your devices, or wait until we&#39;ve got radius configured
- Install git
  - we will use github for a few other things so may as well install git
    - sudo apt-get install git
- Pi-Hole DNS filtering configuration
  - curl -L https://install.pi-hole.net | bash
    - this is the automated install, you can optionally clone the github repo and do it that way as its not generally a good idea to use anything from the web that ends in | bash
  - after installation there are a few things you can do, most importantly uninstall lighttpd.
    - sudo apt-get remove lighttpd -y
      - we will be using apache for other things so its all good to remove lighttpd
- Install Apache, enable SSL and some other stuff we will need later
  - sudo apt-get install apache2 -y
  - sudo apt-get install php5 libapache2-mod-php5 php5-mysql php5-gd php-pear php-db
  - sudo ln -s /etc/apache2/sites-available/default-ssl.conf /etc/apache2/sites-enabled/
  - sudo a2enmod ssl
  - sudo a2enmod rewrite
  - sudo service apache2 restart
  - navigate to [https://your-pi-ip-address/admin](http://your-pi-ip-address/admin) to check that pi-hole is functioning correctly
    - click on whitelist and make sure you can type a domain and whitelist it
    - click on blacklist and make sure you can type a domain and blacklist it
- Install MySQL for your freeRADIUS install
  - sudo apt-get install mysql-server
    - ignore the root password prompts we will set all that later
  - sudo mysql\_secure\_installation
    - this is where we will set up a root password for your mysql and do a bit to secure the installation
      - set a new root password 32 characters in length, preferably using a random generator
      - disallow remote access - yes
      - remove anonymous user --yes
      - remove test database -yes
- Now we need to grab the latest 3.1.12 version of freeRADIUS from github and compile it from source.  This can be frustrating, but is easy in the end. Lots of dependencies you may or may not use in this one, but this does work to get it installed easily.
  - mkdir /home/pi/radius
  - cd /home/pi/radius
  - git clone -b v3.1.x --single-branch [https://github.com/FreeRADIUS/freeradius-server.git](https://github.com/FreeRADIUS/freeradius-server.git)
    - we don&#39;t use the 4.0 branch yet as it&#39;s only in development
    - the v3.1.x branch is still getting some updates to help functionality
  - cd freeradius-server/
  - sudo apt-get -t jessie-backports libssl-dev -y
  - sudo apt-get install fakeroot build-essential dpkg-dev quilt debhelper libcurl4-openssl-dev libcap-dev libgdbm-dev libiodbc2-dev libjson0-dev libkrb5-dev libldap2-dev libpam0g-dev libpcap-dev libperl-dev libpq-dev libreadline-dev libsasl2-dev libsqlite3-dev libssl-dev libtalloc-dev libwbclient-dev libyubikey-dev libykclient-dev libmemcached-dev libhiredis-dev python-dev samba-dev libkqueue-dev ruby-full apache2 php5 libapache2-mod-php5 php5-mysql php5-gd php-pear php-db libpcre3 libpcre3-dev libc6-dbg libtalloc2-dbg libpcapnav0 libmysqlclient-dev ruby-full snmp snmp-mibs-downloader
  - sudo apt-get install postfix
    - this makes a lot of stuff work better by not erroring out when it needs to send a mail to the user or root account
  - ./configure
    - this will take a while and when its done you need to read the config.log file to see if there are any missing dependencies
    - if config.log doesn&#39;t show any unmet dependencies you can see go to the next stop
  - make
    - same as with configure, watch the output on the screen for failure and warning messages
    - if make doesn&#39;t error out you can proceed to the next stop
  - sudo make install
    - this will install freeRADIUS 3.1.2 as of the writing of this guide
    - it will also take 20 mins
- start freeRADIUS to see if it works
  - sudo radiusd -X
    - check to see if it starts all the way
    - if it does, great we can go configure it for our uses
- install DaloRADIUS
  - cd /home/pi/radius
  - mkdir dalo
  - cd dalo
  - git clone [https://github.com/lirantal/daloradius.git](https://github.com/lirantal/daloradius.git)
  - sudo mkdir /usr/share/daloradius
  - sudo cp -r daloradius/\* /usr/share/daloradius/
  - sudo chown -R www-data:www-data /usr/share/daloradius/
  - we will configure daloradius further later
- create the sql tables for your radius and daloradius installs
  - mysql -u root -p
  - create database raddb;
  - create user raduser@localhost identified by &quot;CREATE A 32 CHARACTER PASSWORD HERE&quot;;
  - grant all on raddb.\* to raduser@localhost;
  - grant super on \*.\* to raduser@localhost;
  - exit
  - sudo mysql -u raduser -p
  - use raddb;
  - source /usr/local/etc/raddb/mods-config/sql/main/mysql/schema.sql
  - show tables;
  - source /usr/share/daloradius/contrib/db/mysql-daloradius.sql
  - show tables;
  - exit
- Now we have to edit the daloradius files to be able to open the database and use it that we configured previously
  - sudo nano /usr/share/daloradius/library/daloradius
    - edit these fields:
      - $configValues[&#39;FREERADIUS\_VERSION&#39;] = &#39;2&#39;;
      - $configValues[&#39;CONFIG\_DB\_ENGINE&#39;] = &#39;mysqli&#39;;
      - $configValues[&#39;CONFIG\_DB\_HOST&#39;] = &#39;localhost&#39;;
      - $configValues[&#39;CONFIG\_DB\_PORT&#39;] = &#39;3306&#39;;
      - $configValues[&#39;CONFIG\_DB\_USER&#39;] = &#39;raduser&#39;;
      - $configValues[&#39;CONFIG\_DB\_PASS&#39;] = &#39;YOUR 32 CHARACTER PASSWORD&#39;;
      - $configValues[&#39;CONFIG\_DB\_NAME&#39;] = &#39;raddb&#39;;
      - $configValues[&#39;CONFIG\_FILE\_RADIUS\_PROXY&#39;] = &#39;/usr/local/etc/raddb/proxy.conf&#39;;
      - $configValues[&#39;CONFIG\_PATH\_RADIUS\_DICT&#39;] = &#39;/usr/share/freeradius/freeradius&#39;;
      - $configValues[&#39;CONFIG\_PATH\_DALO\_VARIABLE\_DATA&#39;] = &#39;/usr/share/daloradius/var&#39;;
      - $configValues[&#39;CONFIG\_IFACE\_PASSWORD\_HIDDEN&#39;] = &#39;yes&#39;;
  - sudo nano /etc/apache2/conf-available/dalo.conf
    - Alias /dalo /usr/share/daloradius/
    - &lt;Directory /usr/share/daloradius/&gt;
      - AuthType Basic
      - AuthName &quot;GET OUT IF YOURE NOT AUTHORIZED, THIS CONNECTION IS MONITORED VERY CLOSELY&quot;
      - AuthUserFile /etc/apache2/passwd/passwords
      - Require valid-user
      - #SSLRequireSSL
      - DirectoryIndex login.php
    - &lt;/Directory&gt;
  - now create a soft link to the conf-enabled folder
    - sudo ln -s /etc/apache2/conf-available/dalo.conf /etc/apache2/conf-enabled/
  - we created a protected directory there so we need to go create a user that can access that directory
    - create a password file
      - sudo htpasswd -c /etc/apache2/passwd/passwords  &lt;USERNAME&gt;
      - create and confirm your password for accessing the daloradius directory
    - add another user
      - sudo htpasswd /etc/apache2/passwd/passwords &lt;NEW USERNAME&gt;
      - enter and confirm your password
  - restart apache2
    - sudo service apache2 restart
  - try to login to [https://yourPI-ip-address/dalo](https://yourPI-ip-address/dalo)
    - enter the user and password you made previously with htpasswd
    - login to daloradius
      - username administrator
      - password radius
    - change the default daloradius password
      - navigate to Config
        - under operator info change the Operator Password
        - logout and test the new operator password
- set radiusd to start on boot
  - sudo nano /etc/init.d/radiusd
  - copy the file from here: [https://whateverthefileis.com](https://whateverthefileis.com)
    - chmod a+x radius
  - sudo apt-get install rcconf
    - sudo rcconf
    - scroll down to the bottom of the page and enable radius
    -
- Other Utilities:
  - screentfetch
    - sudo apt-get install screenfetch -y
    - sudo nano ~/.bashrc
      - add this to the bottom of the file
      - if [-f /usr/bin/screenfetch]; then screenfetch; fi
  - google authenticator
    - this is used to generate time-based one-time passwords for remote access
    - You can use it for freeRADIUS authentication as well, but outside the scope of this guide.
    - because of the security implications of distributing a pre-configured image with google authenticator baked in I wont include it, but I do suggest installing it to restrict ssh access further.
  - Cacti network monitoring
    - a very useful network monitoring system with a large community and ample documentation to configure for monitoring everything on your network
  - Icinga2 + Nagios plugins + Icinga2web
    - similar to Cacti in function, large plugin and expandability.
- Some Additional Configuration with Webmin
  - webmin is not secure by default, and really not secure at all.  I included it in this guide to help people without a ton of Linux experience to use because its convenient
  - Change theme to one that&#39;s more usable
    - click on webmin configuration
      - select Authentic Theme
      - click change
      - wait 30 seconds and reload webmin
  - Change authentication options
    - click on webmin configuration
      - click on authenticator
        - make sure enable password timeouts is selected
        - check block hosts with more than 5 failed logins and add at least 6000 seconds
        - check block users with more than 10 failed logins and add at least 60000 seconds
        - check yes for log failures to syslog
        - check the box for Auto-logout after 10 minutes of inactivity
        - make sure &#39;&#39;offer to remember login permanently&#39;&#39; is NOT checked
        - check the box for Show real hostname instead of name from URL
        - check the box for Limit sessions to the same client IP address
        - leave the record logins and logouts in Utmp unchecked
        - under pre-login banner select No pre-login page
        - for local authentication check &#39;&#39;always require username and password&#39;&#39;
  - IP Access Control
    - click on webmin configuration
      - click on IP Access Control
      - check &#39;&#39;only allow from listed addresses&#39;&#39;
        - add the ip address of your main workstation and any others you want to use
      - click save
  - you can also set up certificate based logins to enhance security.  I&#39;d recommend once you&#39;re familiar with the CLI enough to just get rid of webmin and close up the firewall.  Webmin isn&#39;t secure, but it is convenient.
- Optional freeRADIUS configuration
  - by default, using freeRADIUS provides more granular control over network access but does not use the most secure access methods.  There are multiple ways to configure a certificate authority to enable EAP-TLS, PEAP and EAP-TTLS.  Using those methods the encryption keys used by each connected client to the wireless network are generated every time the user connects and disconnects which makes them siginificantly harder to hack.
